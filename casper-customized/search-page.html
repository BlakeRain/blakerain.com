<form name="search_box" class="search-box" method="GET" action="/search">
  <input type="text" class="site-font" placeholder="Search" name="search_term" />
  <button type="submit">
    <i class="fas fa-search"></i>
  </button>
</form>
<div id="mount-point"></div>
<script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
<script
  src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"
  crossorigin
></script>
<script>
  const e = React.createElement;

  class PostCardImage extends React.Component {
    render() {
      var image;
      if (this.props.post.image) {
        image = e("img", {
          className: "search-card-image",
          src: this.props.post.image,
          alt: this.props.post.title,
        });
      } else {
        image = e(
          "div",
          {
            className: "search-card-image missing",
          },
          "No Image"
        );
      }

      return e("a", { className: "search-card-image-link", href: this.props.post.url }, image);
    }
  }

  class PostCardHeader extends React.Component {
    render() {
      return e(
        "header",
        { className: "search-card-header" },
        e("h2", { className: "search-card-title" }, this.props.post.title)
      );
    }
  }

  class PostCardExcerpt extends React.Component {
    render() {
      return e(
        "section",
        { className: "search-card-excerpt" },
        e("p", {}, this.props.post.excerpt)
      );
    }
  }

  class PostCard extends React.Component {
    render() {
      return e("article", { className: "search-card" }, [
        e(PostCardImage, { key: "image", post: this.props.post }),
        e("a", { key: "a", className: "search-card-content", href: this.props.post.url }, [
          e(PostCardHeader, { key: "header", post: this.props.post }),
          e(PostCardExcerpt, { key: "excerpt", post: this.props.post }),
        ]),
      ]);
    }
  }

  class SearchResults extends React.Component {
    render() {
      return this.props.results.map((post, index) =>
        e(PostCard, { key: String("result" + index), post: post })
      );
    }
  }

  class SearchLoader extends React.Component {
    render() {
      return e("h1", {}, e("i", { className: "fas fa-spin fa-spinner" }));
    }
  }

  class NoResults extends React.Component {
    render() {
      return e("h2", {}, "No Results");
    }
  }

  function showSearchLoader() {
    const mount = document.querySelector("#mount-point");
    ReactDOM.render(e(SearchLoader), mount);
  }

  function showSearchResults(results) {
    const mount = document.querySelector("#mount-point");
    ReactDOM.render(
      e(results.length === 0 ? NoResults : SearchResults, { results: results }),
      mount
    );
  }

  function processSearch() {
    const search_bar = document.querySelector(".search-bar input");
    const search_box = document.querySelector(".search-box input");
    const term = decodeURIComponent(
      /\?search_term=(.*)/.exec(window.location.search)[1].replace(/\+/g, " ").trim()
    );

    if (term.length === 0) {
      return;
    }

    search_bar.value = term;
    search_box.value = term;

    showSearchLoader();
    const req = new XMLHttpRequest();
    req.addEventListener("load", () => {
      const suffix = "?highlight=" + encodeURIComponent(term);
      const results = JSON.parse(req.responseText);
      results.forEach((result) => (result.url = result.url + suffix));
      showSearchResults(results);
    });
    req.open("GET", "https://blakerain.com:9443/search/" + encodeURIComponent(term));
    req.send();
  }

  window.addEventListener("load", function () {
    processSearch();
  });
</script>
